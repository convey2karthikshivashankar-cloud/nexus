name: Policy Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  policy-validation:
    name: Validate Architecture Policies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Verify OPA installation
        run: opa version

      - name: Run OPA policy tests
        run: |
          echo "Running OPA policy tests..."
          opa test policies/ -v
        continue-on-error: false

      - name: Generate service dependency graph
        run: |
          echo "Generating service dependency graph..."
          node scripts/generate-dependency-graph.js > dependency-graph.json
        continue-on-error: true

      - name: Validate service decoupling
        run: |
          echo "Validating service decoupling policy..."
          if [ -f dependency-graph.json ]; then
            opa eval --data policies/nexus_architecture.rego \
                     --input dependency-graph.json \
                     --format pretty \
                     'data.nexus.architecture.deny' | tee policy-violations.txt
            
            # Check if there are any violations
            if grep -q "Direct HTTP calls" policy-violations.txt; then
              echo "‚ùå Policy violations detected!"
              cat policy-violations.txt
              exit 1
            else
              echo "‚úÖ No policy violations detected"
            fi
          else
            echo "‚ö†Ô∏è  Dependency graph not generated, skipping validation"
          fi

      - name: Validate Event Store immutability
        run: |
          echo "Validating Event Store immutability..."
          # Check for UPDATE or DELETE operations on EventStore table
          if grep -r "UPDATE.*EventStore\|DELETE.*EventStore" packages/ --include="*.ts" --include="*.js"; then
            echo "‚ùå Event Store mutation detected! Only INSERT operations are allowed."
            exit 1
          else
            echo "‚úÖ Event Store immutability verified"
          fi

      - name: Validate schema registration
        run: |
          echo "Validating schema registration..."
          # Check that all event types have corresponding schema files
          EVENT_TYPES=$(grep -r "eventType:" packages/ --include="*.ts" | grep -oP "eventType:\s*['\"]\\K[^'\"]+")
          MISSING_SCHEMAS=()
          
          for event in $EVENT_TYPES; do
            if [ ! -f "schemas/${event}.json" ]; then
              MISSING_SCHEMAS+=("$event")
            fi
          done
          
          if [ ${#MISSING_SCHEMAS[@]} -gt 0 ]; then
            echo "‚ùå Missing schemas for events: ${MISSING_SCHEMAS[*]}"
            exit 1
          else
            echo "‚úÖ All events have registered schemas"
          fi

      - name: Validate JSON schema syntax
        run: |
          echo "Validating JSON schema syntax..."
          INVALID_SCHEMAS=()
          
          for schema_file in schemas/*.json; do
            if [ -f "$schema_file" ]; then
              if ! jq empty "$schema_file" 2>/dev/null; then
                INVALID_SCHEMAS+=("$schema_file")
              fi
            fi
          done
          
          if [ ${#INVALID_SCHEMAS[@]} -gt 0 ]; then
            echo "‚ùå Invalid JSON in schemas: ${INVALID_SCHEMAS[*]}"
            exit 1
          else
            echo "‚úÖ All schemas have valid JSON syntax"
          fi

      - name: Validate schema compatibility (if AWS credentials available)
        if: env.AWS_ACCESS_KEY_ID != ''
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
          SCHEMA_REGISTRY_NAME: ${{ secrets.SCHEMA_REGISTRY_NAME || 'nexus-event-schema-registry' }}
        run: |
          echo "Validating schema compatibility with AWS Glue Schema Registry..."
          cd packages/adapters/aws
          npm install
          npm test -- GlueSchemaRegistry.integration.test.ts --testNamePattern="compatibility"
        continue-on-error: true

      - name: Enforce schema validation in event publishing
        run: |
          echo "Verifying schema validation is enforced in event publishing..."
          # Check that EventStore.append() validates against schema registry
          if grep -r "schemaRegistry.validate" packages/command-service/src/infrastructure/EventStore.ts; then
            echo "‚úÖ Schema validation enforced in EventStore"
          else
            echo "‚ùå EventStore must validate events against schema registry before persistence"
            exit 1
          fi
          
          # Check that EventRouter validates before routing
          if grep -r "schemaRegistry.validate" packages/event-router/src/index.ts; then
            echo "‚úÖ Schema validation enforced in EventRouter"
          else
            echo "‚ùå EventRouter must validate events against schema registry before routing"
            exit 1
          fi

      - name: Validate temporal query rate limiting
        run: |
          echo "Validating temporal query rate limiting..."
          # Check that temporal query endpoints have rate limiting
          if grep -r "/api/queries/temporal" packages/ --include="*.ts" -A 10 | grep -q "rateLimit"; then
            echo "‚úÖ Temporal query rate limiting verified"
          else
            echo "‚ùå Temporal query endpoints must have rate limiting (10 req/min/client)"
            exit 1
          fi

      - name: Policy validation summary
        if: always()
        run: |
          echo "========================================="
          echo "Policy Validation Summary"
          echo "========================================="
          echo "‚úÖ OPA policy tests passed"
          echo "‚úÖ Service decoupling verified"
          echo "‚úÖ Event Store immutability verified"
          echo "‚úÖ Schema registration verified"
          echo "‚úÖ Rate limiting verified"
          echo "========================================="
          echo "All architectural policies enforced!"

  block-deployment-on-violation:
    name: Block Deployment on Policy Violation
    runs-on: ubuntu-latest
    needs: policy-validation
    if: failure()
    
    steps:
      - name: Block deployment
        run: |
          echo "========================================="
          echo "üö´ DEPLOYMENT BLOCKED"
          echo "========================================="
          echo "Policy violations detected!"
          echo "Lambda deployments are blocked until violations are resolved."
          echo ""
          echo "Review the policy-validation job logs for details."
          echo "========================================="
          exit 1
